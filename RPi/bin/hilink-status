#!/bin/sh

MODEM_IP="192.168.8.1"

curl -s -X GET "http://$MODEM_IP/api/webserver/SesTokInfo" > /tmp/ses_tok.xml
COOKIE=`grep "SessionID=" /tmp/ses_tok.xml | cut -b 10-147`
TOKEN=`grep "TokInfo" /tmp/ses_tok.xml | cut -b 10-41`

curl -s -X GET "http://$MODEM_IP/api/monitoring/status" \
-H "Cookie: $COOKIE" -H "__RequestVerificationToken: $TOKEN" \
-H "Content-Type: text/xml" > /tmp/modem_status.xml

CONN_STATUS=$( xmllint --xpath "string(//ConnectionStatus)" /tmp/modem_status.xml )
SIGNAL_CURRENT=$( xmllint --xpath "string(//SignalIcon)" /tmp/modem_status.xml )
SIGNAL_MAX=$( xmllint --xpath "string(//maxsignal)" /tmp/modem_status.xml )

curl -s -X GET "http://$MODEM_IP/api/device/information" \
-H "Cookie: $COOKIE" -H "__RequestVerificationToken: $TOKEN" \
-H "Content-Type: text/xml" > /tmp/modem_info.xml

CONN_MODE=$( xmllint --xpath "string(//workmode)" /tmp/modem_info.xml )

curl -s -X GET "http://$MODEM_IP/api/monitoring/traffic-statistics" \
-H "Cookie: $COOKIE" -H "__RequestVerificationToken: $TOKEN" \
-H "Content-Type: text/xml" > /tmp/modem_usage.xml

UPTIME=$( xmllint --xpath "string(//CurrentConnectTime)" /tmp/modem_usage.xml )
UPLOAD=$( xmllint --xpath "string(//CurrentUpload)" /tmp/modem_usage.xml )
DLLOAD=$( xmllint --xpath "string(//CurrentDownload)" /tmp/modem_usage.xml )
ULRATE=$( xmllint --xpath "string(//CurrentUploadRate)" /tmp/modem_usage.xml )
DLRATE=$( xmllint --xpath "string(//CurrentDownloadRate)" /tmp/modem_usage.xml )

case $CONN_STATUS in
	900 )
		CONN_STATUS_MAPPED="Connecting..." ;;
	901 )
		CONN_STATUS_MAPPED="Connected" ;;
	902 )
		CONN_STATUS_MAPPED="Disconnected" ;;
	* )
		CONN_STATUS_MAPPED="Unknown" ;;
esac

ULRATE_MBIT=$(echo "scale=1; x=$ULRATE/1024/1024*8; if(x<1 && x!=0) print 0; x" | bc)
DLRATE_MBIT=$(echo "scale=1; x=$DLRATE/1024/1024*8; if(x<1 && x!=0) print 0; x" | bc)

UPLOAD_MB=$(echo "scale=1; x=$UPLOAD/1024/1024; if(x<1 && x!=0) print 0; x" | bc)
DLLOAD_MB=$(echo "scale=1; x=$DLLOAD/1024/1024; if(x<1 && x!=0) print 0; x" | bc)

COLOR_OK="\033[32m"
COLOR_WARN="\033[33"
COLOR_ERR="\033[31"

echo "status:\t\t$CONN_STATUS_MAPPED ($CONN_MODE)"
echo "signal:\t\t$SIGNAL_CURRENT/$SIGNAL_MAX "
echo "uptime:\t\t$( printf '%dh:%dm:%ds\n' $(($UPTIME/3600)) $(($UPTIME%3600/60)) $(($UPTIME%60)) )"
echo "link:\t\t$ULRATE_MBIT/$DLRATE_MBIT Mbit"
echo "usage:\t\t$UPLOAD_MB/$DLLOAD_MB MB"

exit 0
