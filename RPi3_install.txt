Raspberry Pi 3
==============

Install Raspian Jessie from https://www.raspberrypi.org/downloads/raspbian/

built-in wlan0 is used to connect to tethered iPhone (wpa_supplicant)
TP-Link TL-WN723N wlan1 USB adapter is used as AP (hostapd)

sudo apt-get install socat hostapd dnsmasq tcpdump telnet inetutils nano wpasupplicant
sudo apt-get remove avahi-daemon 

Make the following changes in these files:

use wpa_passphrase to create the contents for /etc/wpa_supplicant/wpa_supplicant.conf
If you need special characters, refer to this example: ssid=P"MyName\x27s\x20Phone"


/etc/network/interfaces
# add/change the following (leave lo and eth0 untouched)
	allow-hotplug wlan1
	auto wlan1 wlan1:1
	iface wlan1 inet static
	hostapd /etc/hostapd/hostapd.conf
	address 192.168.42.200
	netmask 255.255.255.0
	
	iface wlan1:1 inet static
	address 192.168.42.1
	netmask 255.255.255.0
	
	allow-hotplug wlan0
	iface wlan0 inet dhcp
	    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf


/etc/hostapd/hostapd.conf
# add/change the following, set your own wpa_passphrase and ssid: 123456 should be the same number as the 6 digits in your Disco's SSID
# the vendor_elemtns is based on CHUCK's serial number. Do a 'sudo iwlist scan' and use the same from DISCO, but change the very last digit just before the end padding (00), e.g. -1
	interface=wlan1
	ssid=PISCO-123456
	ieee80211n=1
	wpa=2
	wpa_passphrase=same_password_as_disco's_wpa_password
	wpa_key_mgmt=WPA-PSK
	rsn_pairwise=CCMP
	vendor_elements=dd189003b7090eXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX00
	hw_mode=g


/etc/dnsmasq.conf
# add/change the following
	interface=lo,wlan1
	no-dhcp-interface=lo
	dhcp-range=192.168.42.201,192.168.42.210,255.255.255.0,12h
	dhcp-option=3


/etc/sysctl.conf
# add/change the following
	net.ipv4.ip_forward=1


/etc/modprobe.d/8192cu.conf
# add/change the following
	options 8192cu rtw_power_mgnt=0 rtw_enusbss=0


/etc/rc.local
# add before exit 0
	/home/pi/startup.sh &


/home/pi/startup.sh
# add the following, replace XXX with the SC2's IP, my_host_name with your free no-ip.com hostname
	#!/bin/bash
	while true; do
	    ip_ext=`host my_host_name.zapto.org NF1.NO-IP.COM | awk '/has address/ { print $4 }'`
	    ping -c 1 ${ip_ext}
	    if [ $? -eq 0 ]; then
	        break
	    fi
	    sleep 1
	done
	
	ip_sc2='192.168.42.XXX'
	# ip_sc2=`grep -i 'a0:14:3d' /var/lib/misc/dnsmasq.leases | head -1 | awk '{ print $3 }'`
	# I went back to hardcoding the SC2's DHCP client address, as by the time this script runs, dnsmasq.leases is not yet updated.
	
	pppd noauth noipdefault nodetach pty "nc ${ip_ext} 3333" &
	iptables -t nat -A PREROUTING -d 192.168.42.1 -j DNAT --to-destination 192.168.42.211
	iptables -t nat -A POSTROUTING -d 192.168.42.211 -j SNAT --to-source 192.168.42.210
	
	iptables -t nat -A PREROUTING -d 192.168.42.210 -j DNAT --to-destination ${ip_sc2}
	iptables -t nat -A POSTROUTING -d ${ip_sc2} -j SNAT --to-source 192.168.42.1


Reboot the RPi3
